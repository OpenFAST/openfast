@test
subroutine test_BD_TrapezoidalPointWeight()
    ! test branches
    ! - calculation made for bd_5MW_dynamic regression test
    ! - 10 random points, refine = 1
    ! - 10 random points, refine = 2
    ! - 10 random points, refine = 3
    ! - 10 random points, refine = 4
    ! - 13 random points, refine = 1

    ! --------------------------------------------------------------------------
    ! --------------------------------------------------------------------------
    ! In BD_TrapezoidalPointWeight(), the trapezoidal quadrature points (scaled 
    ! to [-1, 1]) and weights are calculated using the station location in the
    ! [0, 1] 'eta' frame, the number of blade input stations (station_total),
    ! the level of refinement (i.e., the factor for how many extra quadrature
    ! points to fill between the ones corresponding to input stations), and the
    ! number of quadrature points per element (nqp).
    ! This test verifies that these calculations are done properly for a range
    ! of values for station_total and refine.
    ! NOTE: The inputs for all of the following tests employ ordered U(0,1)
      ! values for station_eta, and the baseline outputs are generated by a
      ! Matlab script (included below).
    ! --------------------------------------------------------------------------
    ! --------------------------------------------------------------------------

    use pFUnit_mod
    use BeamDyn_Subs
    use NWTC_Num
    use test_tools

    implicit none

    integer(IntKi)          :: nqp
    integer(IntKi)          :: refine
    real(BDKi), allocatable :: QPtLocs(:), QPtWeight(:)
    integer(IntKi)          :: station_total
    real(BDKi), allocatable :: station_eta(:)
    real(BDKi), allocatable :: BaseLocs(:), BaseWeight(:)

    character(1024) :: testname
    integer(IntKi)  :: accuracy
    real(BDKi)      :: tolerance

    ! initialize NWTC_Num constants
    call SetConstants()

    ! digits of desired accuracy
    accuracy = 14

    ! --------------------------------------------------------------------------
    testname = "10 randomly-chosen points in [0, 1], refine = 1:"

    station_total = 10
    refine        = 1
    nqp           = station_total * refine - (refine - 1)

    allocate(QPtLocs(nqp), QPtWeight(nqp), station_eta(station_total), BaseLocs(nqp), BaseWeight(nqp))

    station_eta = (/ 0.000000000000000, 0.162611735194631, 0.276025076998578,&
                     0.445586200710899, 0.498364051982143, 0.646313010111265,&
                     0.655098003973841, 0.679702676853675, 0.709364830858073,&
                     1.000000000000000 /)

    QPtLocs   = 0.0_BDKi
    QPtWeight = 0.0_BDKi

    BaseLocs = (/ -1.000000000000000, -0.674776529610739, -0.447949846002843,&
                  -0.108827598578201, -0.003271896035714,  0.292626020222529,&
                   0.310196007947681,  0.359405353707350,  0.418729661716145,&
                   1.000000000000000 /)

    BaseWeight = (/ 0.162611735194631, 0.276025076998578, 0.282974465516269,&
                    0.222338974983565, 0.200726809400365, 0.156733951991698,&
                    0.033389666742410, 0.054266826884232, 0.320297323146325,&
                    0.290635169141927 /)

    call BD_TrapezoidalPointWeight( nqp, refine, station_eta, station_total, QPtLocs, QPtWeight )

    tolerance = AdjustTol(accuracy, BaseLocs)
    @assertEqual(BaseLocs, QPtLocs, tolerance, testname)
    tolerance = AdjustTol(accuracy, BaseWeight)
    @assertEqual(BaseWeight, QPtWeight, tolerance, testname)

    deallocate(QPtLocs, QPtWeight, station_eta, BaseLocs, BaseWeight)

    ! --------------------------------------------------------------------------
    testname = "10 randomly-chosen points in [0, 1], refine = 2:"

    station_total = 10
    refine        = 2
    nqp           = station_total * refine - (refine - 1)

    allocate(QPtLocs(nqp), QPtWeight(nqp), station_eta(station_total), BaseLocs(nqp), BaseWeight(nqp))

    station_eta = (/ 0.000000000000000, 0.251083857976031, 0.349983765984809,&
                     0.351659507062997, 0.473288848902729, 0.549723608291140,&
                     0.585264091152724, 0.616044676146639, 0.830828627896291,&
                     1.000000000000000 /)

    QPtLocs   = 0.0_BDKi
    QPtWeight = 0.0_BDKi

    BaseLocs = (/ -1.000000000000000, -0.748916142023969, -0.497832284047938,&
                  -0.398932376039160, -0.300032468030383, -0.298356726952195,&
                  -0.296680985874006, -0.175051644034274, -0.053422302194541,&
                   0.023012457193869,  0.099447216582279,  0.134987699443864,&
                   0.170528182305449,  0.201308767299363,  0.232089352293278,&
                   0.446873304042930,  0.661657255792582,  0.830828627896291,&
                   1.000000000000000 /)

    BaseWeight = (/ 0.125541928988016, 0.251083857976031, 0.174991882992404,&
                    0.098899908008778, 0.050287824543483, 0.001675741078188,&
                    0.061652541458960, 0.121629341839733, 0.099032050614071,&
                    0.076434759388410, 0.055987621124998, 0.035540482861585,&
                    0.033160533927750, 0.030780584993915, 0.122782268371783,&
                    0.214783951749652, 0.191977661926680, 0.169171372103709,&
                    0.084585686051855 /)

    call BD_TrapezoidalPointWeight( nqp, refine, station_eta, station_total, QPtLocs, QPtWeight )

    tolerance = AdjustTol(accuracy, BaseLocs)
    @assertEqual(BaseLocs, QPtLocs, tolerance, testname)
    tolerance = AdjustTol(accuracy, BaseWeight)
    @assertEqual(BaseWeight, QPtWeight, tolerance, testname)

    deallocate(QPtLocs, QPtWeight, station_eta, BaseLocs, BaseWeight)

    ! --------------------------------------------------------------------------
    testname = "10 randomly-chosen points in [0, 1], refine = 3:"

    station_total = 10
    refine        = 3
    nqp           = station_total * refine - (refine - 1)

    allocate(QPtLocs(nqp), QPtWeight(nqp), station_eta(station_total), BaseLocs(nqp), BaseWeight(nqp))

    station_eta = (/ 0.000000000000000, 0.152378018969223, 0.228976968716819,&
                     0.262971284540144, 0.450541598502498, 0.654079098476782,&
                     0.689214503140008, 0.748151592823709, 0.825816977489547,&
                     1.000000000000000 /)

    QPtLocs   = 0.0_BDKi
    QPtWeight = 0.0_BDKi

    BaseLocs = (/ -1.000000000000000, -0.898414654020518, -0.796829308041036,&
                  -0.695243962061554, -0.644177995563157, -0.593112029064760,&
                  -0.542046062566362, -0.519383185350812, -0.496720308135262,&
                  -0.474057430919711, -0.349010554944809, -0.223963678969907,&
                  -0.098916802995004,  0.036774863654518,  0.172466530304042,&
                   0.308158196953565,  0.331581800062382,  0.355005403171198,&
                   0.378429006280016,  0.417720399402483,  0.457011792524951,&
                   0.496303185647419,  0.548080108757978,  0.599857031868536,&
                   0.651633954979095,  0.767755969986063,  0.883877984993032,&
                   1.000000000000000 /)

    BaseWeight = (/ 0.050792672989741, 0.101585345979482, 0.101585345979482,&
                    0.076325656238940, 0.051065966498397, 0.051065966498397,&
                    0.036864421856974, 0.022662877215550, 0.022662877215550,&
                    0.073854876595226, 0.125046875974902, 0.125046875974902,&
                    0.130369271312213, 0.135691666649523, 0.135691666649523,&
                    0.079557634879170, 0.023423603108817, 0.023423603108817,&
                    0.031357498115642, 0.039291393122468, 0.039291393122468,&
                    0.045534158116513, 0.051776923110559, 0.051776923110559,&
                    0.083949469058764, 0.116122015006968, 0.116122015006968,&
                    0.058061007503484 /)

    call BD_TrapezoidalPointWeight( nqp, refine, station_eta, station_total, QPtLocs, QPtWeight )

    tolerance = AdjustTol(accuracy, BaseLocs)
    @assertEqual(BaseLocs, QPtLocs, tolerance, testname)
    tolerance = AdjustTol(accuracy, BaseWeight)
    @assertEqual(BaseWeight, QPtWeight, tolerance, testname)

    deallocate(QPtLocs, QPtWeight, station_eta, BaseLocs, BaseWeight)

    ! --------------------------------------------------------------------------
    testname = "10 randomly-chosen points in [0, 1], refine = 4:"

    station_total = 10
    refine        = 4
    nqp           = station_total * refine - (refine - 1)

    allocate(QPtLocs(nqp), QPtWeight(nqp), station_eta(station_total), BaseLocs(nqp), BaseWeight(nqp))

    station_eta = (/ 0.000000000000000, 0.046171390631154, 0.097131781235848,&
                     0.171186687811562, 0.276922984960890, 0.392227019534168,&
                     0.655477890177557, 0.706046088019609, 0.743132468124916,&
                     1.000000000000000 /)

    QPtLocs   = 0.0_BDKi
    QPtWeight = 0.0_BDKi

    BaseLocs = (/ -1.000000000000000, -0.976914304684423, -0.953828609368846,&
                  -0.930742914053269, -0.907657218737692, -0.882177023435345,&
                  -0.856696828132998, -0.831216632830651, -0.805736437528304,&
                  -0.768708984240447, -0.731681530952590, -0.694654077664733,&
                  -0.657626624376876, -0.604758475802212, -0.551890327227548,&
                  -0.499022178652884, -0.446154030078220, -0.388502012791581,&
                  -0.330849995504942, -0.273197978218303, -0.215545960931664,&
                  -0.083920525609970,  0.047704909711725,  0.179330345033419,&
                   0.310955780355114,  0.336239879276140,  0.361523978197166,&
                   0.386808077118192,  0.412092176039218,  0.430635366091872,&
                   0.449178556144525,  0.467721746197178,  0.486264936249832,&
                   0.614698702187374,  0.743132468124916,  0.871566234062458,&
                   1.000000000000000 /)

    BaseWeight = (/ 0.011542847657789, 0.023085695315577, 0.023085695315577,&
                    0.023085695315577, 0.024282945308962, 0.025480195302347,&
                    0.025480195302347, 0.025480195302347, 0.031253824295102,&
                    0.037027453287857, 0.037027453287857, 0.037027453287857,&
                    0.044947800931260, 0.052868148574664, 0.052868148574664,&
                    0.052868148574664, 0.055260082930651, 0.057652017286639,&
                    0.057652017286639, 0.057652017286639, 0.094638726304167,&
                    0.131625435321695, 0.131625435321694, 0.131625435321694,&
                    0.078454767121360, 0.025284098921026, 0.025284098921026,&
                    0.025284098921026, 0.021913644486840, 0.018543190052653,&
                    0.018543190052653, 0.018543190052653, 0.073488477995098,&
                    0.128433765937542, 0.128433765937542, 0.128433765937542,&
                    0.064216882968771 /)

    call BD_TrapezoidalPointWeight( nqp, refine, station_eta, station_total, QPtLocs, QPtWeight )

    tolerance = AdjustTol(accuracy, BaseLocs)
    @assertEqual(BaseLocs, QPtLocs, tolerance, testname)
    tolerance = AdjustTol(accuracy, BaseWeight)
    @assertEqual(BaseWeight, QPtWeight, tolerance, testname)

    deallocate(QPtLocs, QPtWeight, station_eta, BaseLocs, BaseWeight)

    ! --------------------------------------------------------------------------
    testname = "13 randomly-chosen points in [0, 1], refine = 1:"

    station_total = 13
    refine        = 1
    nqp           = station_total * refine - (refine - 1)

    allocate(QPtLocs(nqp), QPtWeight(nqp), station_eta(station_total), BaseLocs(nqp), BaseWeight(nqp))

    station_eta = (/ 0.000000000000000, 0.144954798223727, 0.145538980384717,&
                     0.181847028302852, 0.263802916521990, 0.431413827463545,&
                     0.549860201836332, 0.579704587365570, 0.622055131485066,&
                     0.800068480224308, 0.853031117721894, 0.869292207640089,&
                     1.000000000000000 /)

    QPtLocs   = 0.0_BDKi
    QPtWeight = 0.0_BDKi

    BaseLocs = (/ -1.000000000000000, -0.710090403552546, -0.708922039230566,&
                  -0.636305943394295, -0.472394166956020, -0.137172345072911,&
                   0.099720403672664,  0.159409174731140,  0.244110262970132,&
                   0.600136960448615,  0.706062235443787,  0.738584415280179,&
                   1.000000000000000 /)

    BaseWeight = (/ 0.144954798223727, 0.145538980384717, 0.036892230079126,&
                    0.118263936137273, 0.249566799160692, 0.286057285314342,&
                    0.148290759902026, 0.072194929648734, 0.220363892858737,&
                    0.230975986236828, 0.069223727415782, 0.146968882278106,&
                    0.130707792359911 /)

    call BD_TrapezoidalPointWeight( nqp, refine, station_eta, station_total, QPtLocs, QPtWeight )

    tolerance = AdjustTol(accuracy, BaseLocs)
    @assertEqual(BaseLocs, QPtLocs, tolerance, testname)
    tolerance = AdjustTol(accuracy, BaseWeight)
    @assertEqual(BaseWeight, QPtWeight, tolerance, testname)

    deallocate(QPtLocs, QPtWeight, station_eta, BaseLocs, BaseWeight)

    ! --------------------------------------------------------------------------
    testname = "97 randomly-chosen points in [0, 1], refine = 1:"

    station_total = 97
    refine        = 1
    nqp           = station_total * refine - (refine - 1)

    allocate(QPtLocs(nqp), QPtWeight(nqp), station_eta(station_total), BaseLocs(nqp), BaseWeight(nqp))

    station_eta = (/               0.0,&
                     0.028674152464106, 0.032600820530528, 0.042431137500742,&
                     0.052676997680793, 0.059618867579639, 0.060471179169894,&
                     0.071445464600642, 0.083469814858914, 0.096730025780867,&
                     0.106216344928664, 0.120611613297162, 0.128014399720173,&
                     0.133171007607162, 0.149865442477967, 0.156404952226563,&
                     0.167168409914656, 0.167927145682257, 0.171121066356432,&
                     0.173388613119006, 0.178132454400338, 0.190433267179954,&
                     0.190923695236303, 0.198118402542975, 0.226187679752676,&
                     0.239932010568717, 0.251806122472313, 0.265280909810029,&
                     0.269119426398556, 0.290440664276979, 0.291984079961715,&
                     0.301454948712065, 0.339493413390758, 0.343877004114983,&
                     0.368916546063895, 0.372409740055537, 0.376272210278832,&
                     0.384619124369411, 0.390937802323736, 0.399257770613576,&
                     0.416799467930787, 0.417744104316662, 0.422835615008808,&
                     0.428252992979386, 0.431651170248720, 0.432391503783462,&
                     0.453797708726919, 0.460725937260412, 0.471088374541939,&
                     0.482022061031856, 0.489687638016024, 0.489901388512224,&
                     0.500471624154843, 0.518594942510538, 0.521649842464284,&
                     0.526875830508296, 0.539126465042857, 0.547870901214845,&
                     0.561199792709660, 0.582986382747674, 0.589507484695059,&
                     0.617090884393223, 0.627973359190104, 0.644764536870088,&
                     0.648991492712356, 0.656859890973707, 0.659605252908307,&
                     0.666338851584426, 0.666527913402587, 0.669175304534394,&
                     0.681971904149063, 0.698105520180308, 0.701098755900926,&
                     0.712694471678914, 0.722439592366842, 0.730248792267598,&
                     0.737858095516997, 0.800330575352401, 0.803364391602440,&
                     0.817547092079286, 0.818148553859625, 0.824376266688835,&
                     0.825313795402046, 0.831379742839070, 0.855522805845911,&
                     0.881866500451810, 0.886511933076101, 0.920332039836564,&
                     0.942736984276934, 0.951630464777727, 0.972974554763863,&
                     0.978680649641159, 0.981637950970750, 0.982663399721950,&
                     0.983052466469856, 0.984063724379154, 1.000000000000000 /)

    QPtLocs   = 0.0_BDKi
    QPtWeight = 0.0_BDKi

    BaseLocs = (/ -1.000000000000000, -0.942651695071788, -0.934798358938944,&
                  -0.915137724998517, -0.894646004638415, -0.880762264840722,&
                  -0.879057641660213, -0.857109070798715, -0.833060370282172,&
                  -0.806539948438266, -0.787567310142672, -0.758776773405675,&
                  -0.743971200559655, -0.733657984785677, -0.700269115044066,&
                  -0.687190095546873, -0.665663180170688, -0.664145708635486,&
                  -0.657757867287136, -0.653222773761989, -0.643735091199324,&
                  -0.619133465640092, -0.618152609527394, -0.603763194914051,&
                  -0.547624640494649, -0.520135978862565, -0.496387755055374,&
                  -0.469438180379941, -0.461761147202888, -0.419118671446041,&
                  -0.416031840076570, -0.397090102575869, -0.321013173218485,&
                  -0.312245991770034, -0.262166907872210, -0.255180519888926,&
                  -0.247455579442337, -0.230761751261178, -0.218124395352529,&
                  -0.201484458772849, -0.166401064138426, -0.164511791366676,&
                  -0.154328769982384, -0.143494014041228, -0.136697659502560,&
                  -0.135216992433077, -0.092404582546161, -0.078548125479177,&
                  -0.057823250916121, -0.035955877936287, -0.020624723967952,&
                  -0.020197222975552,  0.000943248309686,  0.037189885021076,&
                   0.043299684928567,  0.053751661016592,  0.078252930085713,&
                   0.095741802429689,  0.122399585419320,  0.165972765495348,&
                   0.179014969390118,  0.234181768786447,  0.255946718380208,&
                   0.289529073740176,  0.297982985424712,  0.313719781947414,&
                   0.319210505816614,  0.332677703168851,  0.333055826805174,&
                   0.338350609068788,  0.363943808298126,  0.396211040360617,&
                   0.402197511801853,  0.425388943357828,  0.444879184733685,&
                   0.460497584535195,  0.475716191033993,  0.600661150704803,&
                   0.606728783204880,  0.635094184158573,  0.636297107719249,&
                   0.648752533377670,  0.650627590804091,  0.662759485678139,&
                   0.711045611691823,  0.763733000903620,  0.773023866152203,&
                   0.840664079673128,  0.885473968553869,  0.903260929555454,&
                   0.945949109527725,  0.957361299282318,  0.963275901941499,&
                   0.965326799443901,  0.966104932939712,  0.968127448758308,&
                   1.000000000000000 /)

    BaseWeight = (/ 0.028674152464106, 0.032600820530528, 0.013756985036636,&
                    0.020076177150265, 0.017187730078898, 0.007794181489101,&
                    0.011826597021003, 0.022998635689020, 0.025284561180225,&
                    0.022746530069750, 0.023881587516295, 0.021798054791509,&
                    0.012559394309999, 0.021851042757794, 0.023233944619402,&
                    0.017302967436689, 0.011522193455693, 0.003952656441776,&
                    0.005461467436749, 0.007011388043906, 0.017044654060949,&
                    0.012791240835965, 0.007685135363021, 0.035263984516373,&
                    0.041813608025743, 0.025618442719637, 0.025348899241312,&
                    0.017313303926243, 0.025159754466950, 0.022864653563159,&
                    0.011014284435086, 0.047509333429043, 0.042422055402918,&
                    0.029423132673137, 0.028532735940554, 0.007355664214937,&
                    0.012209384313874, 0.014665592044904, 0.014638646244165,&
                    0.025861665607051, 0.018486333703086, 0.006036147078021,&
                    0.010508888662724, 0.008815555239912, 0.004138510804076,&
                    0.022146538478199, 0.028334433476950, 0.017290665815020,&
                    0.021296123771445, 0.018599263474085, 0.007879327480368,&
                    0.010783986138819, 0.028693553998314, 0.021178218309441,&
                    0.008280887997758, 0.017476622578573, 0.020995070706549,&
                    0.022073327666803, 0.035115481532829, 0.028307691985399,&
                    0.034104501645549, 0.038465874495045, 0.027673652476865,&
                    0.021018133522252, 0.012095354103619, 0.010613760195951,&
                    0.009478960610718, 0.006922660494280, 0.002836452949968,&
                    0.015443990746476, 0.028930215645915, 0.019126851751863,&
                    0.014588951498606, 0.021340836465916, 0.017554320588684,&
                    0.015418503150154, 0.070081783084804, 0.065506296085444,&
                    0.017216516726885, 0.014784162257184, 0.006829174609549,&
                    0.007165241542421, 0.007003476150235, 0.030209010443866,&
                    0.050486757612740, 0.030989127230190, 0.038465539384754,&
                    0.056225051200833, 0.031298424941163, 0.030237570486928,&
                    0.027050184863432, 0.008663396206887, 0.003982750080792,&
                    0.001414515499106, 0.001400324657204, 0.016947533530144,&
                    0.015936275620846 /)

    call BD_TrapezoidalPointWeight( nqp, refine, station_eta, station_total, QPtLocs, QPtWeight )

    tolerance = AdjustTol(accuracy, BaseLocs)
    @assertEqual(BaseLocs, QPtLocs, tolerance, testname)
    tolerance = AdjustTol(accuracy, BaseWeight)
    @assertEqual(BaseWeight, QPtWeight, tolerance, testname)

    deallocate(QPtLocs, QPtWeight, station_eta, BaseLocs, BaseWeight)

    ! --------------------------------------------------------------------------

end subroutine test_BD_TrapezoidalPointWeight

! ! This is the Matlab script used to generate the outputs for the tests above
! ! It is based on BD_TrapezoidalPointWeight(), itself, as it is on 5/30/18

! format long

! station_total = 10;
! id0 = 1;
! refine = 1;
! nqp = station_total * refine - (refine - 1);
! QPtLocs = zeros(1, nqp);
! QPtWeight = zeros(1, nqp);

! % use this to generate a new random eta vector
! % station_eta = sort(rand(1, station_total, 'double'));
! % station_eta(1) = 0;
! % station_eta(end) = 1;
! % station_eta

! % % fill this in to use a specific eta vector
! station_eta = [0.000000000000000, 0.162611735194631, 0.276025076998578,...
!                0.445586200710899, 0.498364051982143, 0.646313010111265,...
!                0.655098003973841, 0.679702676853675, 0.709364830858073,...
!                1.000000000000000]

! QPtLocs(1) = station_eta(1);
! for j = 2 : nqp
!     indx =  1 + fix((j - 2) / refine);
!     QPtLocs(j) =  station_eta(indx) + ((station_eta(indx + 1) - station_eta(indx)) / refine) * (mod(j - 2, refine) + 1);
! end
! QPtLocs = 2.0 * QPtLocs - 1.0

! id1 = station_total;
! temp_id0 = (id0 - 1) * refine + 1;
! temp_id1 = (id1 - 1) * refine + 1;
! denom = QPtLocs(temp_id1) - QPtLocs(temp_id0);

! QPtWeight(1)     =  (QPtLocs(temp_id0 + 1) - QPtLocs(temp_id0)) / denom;
! for j = 2 : nqp - 1
!     QPtWeight(j)  =  (QPtLocs(temp_id0 + j) - QPtLocs(temp_id0 + j - 2)) / denom;
! end
! QPtWeight(nqp) =  (QPtLocs(temp_id1) - QPtLocs(temp_id1 - 1)) / denom

