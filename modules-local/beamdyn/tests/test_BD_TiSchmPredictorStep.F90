@test
subroutine test_BD_TiSchmPredictorStep()
    ! test branches
    ! - simple case--zero displacement (x%q == 0)
    ! - more complex case--nonzero displacement (x%q /= 0)
    
    use pFUnit_mod
    use BeamDyn
    use NWTC_Num
    
    implicit none
    
    real(DbKi)                   :: dt
    real(DbKi)                   :: coef(9)
    integer(IntKi)               :: node_total
    type(BD_ContinuousStateType) :: x
    type(BD_OtherStateType)      :: OtherState
    real(BDKi)                   :: base_q(6, 6), base_dqdt(6, 6), base_acc(6, 6), base_xcc(6, 6)

    
    
    integer(IntKi)  :: ErrStat ! Error status of the operation
    character(1024) :: ErrMsg  ! Error message if ErrStat /= ErrID_None
    
    character(1024) :: testname
    real(BDKi)      :: tolerance
    
    ! initialize NWTC_Num constants
    call SetConstants()
    
    tolerance  = 1e-14
    
    node_total = 6

    call AllocAry(x%q, 6, 6, 'x_q', ErrStat, ErrMsg)
    call AllocAry(x%dqdt, 6, 6, 'x_dqdt', ErrStat, ErrMsg)
    call AllocAry(OtherState%acc, 6, 6, 'os_acc', ErrStat, ErrMsg)
    call AllocAry(OtherState%xcc, 6, 6, 'os_xcc', ErrStat, ErrMsg)
   
    ! --------------------------------------------------------------------------
    testname = "simple case--zero displacement (x%q == 0):"

    call initialize_vars_base()

    dt   = 1.99999999999999999999999999999999989E-0003
    coef = (/ 0.00000000000000000000000000000000000, 0.00000000000000000000000000000000000,&
              0.00000000000000000000000000000000000, 4.99999999999999999999999999999999971E-0004,&
              0.00000000000000000000000000000000000, 0.500000000000000000000000000000000000,&
              1.49999999999999999999999999999999991E-0003, 1.99999999999999999999999999999999986E-0006, &
              0.500000000000000000000000000000000000 /)

    x%dqdt(2, :)         = (/ -1.0005999999999999, -8.2294835184424606, -22.992918346741089,&
                             -40.545181653258901, -55.308616481557529, -62.537499999999994 /)
    x%dqdt(4, :)         = (/ 1.0005999999999999, 1.0005999999999999, 1.0005999999999999,&
                              1.0005999999999999, 1.0005999999999999, 1.0005999999999999 /)
    
    OtherState%acc(1, :) = (/ 0.0000000000000000, 9.1030935971324266E-031, 2.9670175180200771E-031,&
                             -1.2441529431333375E-031, 2.8312823582193228E-031, -1.2314608234956747E-030 /)
    OtherState%acc(2, :) = (/ 0.0000000000000000, -11.403692002792821, -8.6643304762126938,&
                            -10.982868549102667, -8.1314432638696434, -16.357570971015893 /)
    OtherState%acc(3, :) = (/ -1.0012003599999999, 0.16383847046177183, -0.11602374857723628,&
                               0.12084575685655913, -0.17046526580552815, 0.66994310376601041 /)
    OtherState%acc(4, :) = (/ 0.0000000000000000, -1.8740607602069020E-013, -1.5871245543313705E-013,&
                             -2.8546948371704961E-013, 4.8364282011247346E-013, -1.5308615853255622E-013 /)
    OtherState%acc(5, :) = (/ 0.0000000000000000, -1.8547934120218363E-014, -7.8088027096225626E-014,&
                             -1.2469662453529838E-013, 8.5498983741128486E-014, 1.0156279629834294E-013 /)
    OtherState%acc(6, :) = (/ 0.0000000000000000, 5.2028668129240181E-002, 9.5849158180190366E-002,&
                              5.1028765776352077E-002, 2.1119337050903322E-002, -7.1219186400549278E-002 /)
    
    OtherState%xcc       = OtherState%acc

    base_q(2, :)         = (/ 0.0000000000000000, -1.6458967036884920E-002, -4.5985836693482177E-002,&
                             -8.1090363306517796E-002, -0.11061723296311506, -0.12507499999999999 /)
    base_q(4, :)         = (/ 0.0000000000000000, 2.0011999999999999E-003, 2.0011999999999999E-003,&
                              2.0011999999999999E-003, 2.0011999999999999E-003, 2.0011999999999999E-003 /)
    
    base_dqdt(1, :)      = (/ 0.0000000000000000, 4.5515467985662132E-034, 1.4835087590100385E-034,&
                             -6.2207647156666881E-035, 1.4156411791096615E-034, -6.1573041174783731E-034 /)
    base_dqdt(2, :)      = (/ -1.0005999999999999, -8.2351853644438577, -22.997250511979196,&
                             -40.550673087533454, -55.312682203189460, -62.545678785485499 /)
    base_dqdt(3, :)      = (/ 0.0000000000000000, 8.1919235230885917E-005, -5.8011874288618144E-005,&
                              6.0422878428279564E-005, -8.5232632902764078E-005, 3.3497155188300521E-004 /)
    base_dqdt(4, :)      = (/ 1.0005999999999999, 1.0005999999999999, 1.0005999999999999,&
                              1.0005999999999997, 1.0006000000000002, 1.0005999999999999 /)
    base_dqdt(5, :)      = (/ 0.0000000000000000, -9.2739670601091819E-018, -3.9044013548112813E-017,&
                             -6.2348312267649193E-017, 4.2749491870564245E-017, 5.0781398149171472E-017 /)
    base_dqdt(6, :)      = (/ 0.0000000000000000, 2.6014334064620092E-005, 4.7924579090095182E-005,&
                              2.5514382888176039E-005, 1.0559668525451662E-005, -3.5609593200274638E-005 /)

    base_acc(3, 1)       = -1.0012003599999999

    base_xcc(1, :)       = (/ 0.0000000000000000, 4.5515467985662133E-031, 1.4835087590100385E-031,&
                             -6.2207647156666877E-032, 1.4156411791096614E-031, -6.1573041174783734E-031 /)
    base_xcc(2, :)       = (/ 0.0000000000000000, -5.7018460013964107, -4.3321652381063469,&
                             -5.4914342745513336, -4.0657216319348217, -8.1787854855079463 /)
    base_xcc(3, :)       = (/ -1.0012003599999999, 8.1919235230885915E-002, -5.8011874288618141E-002,&
                               6.0422878428279564E-002, -8.5232632902764074E-002, 0.33497155188300520 /)
    base_xcc(4, :)       = (/ 0.0000000000000000, -9.3703038010345100E-014, -7.9356227716568524E-014,&
                             -1.4273474185852481E-013, 2.4182141005623673E-013, -7.6543079266278108E-014 /)
    base_xcc(5, :)       = (/ 0.0000000000000000, -9.2739670601091815E-015, -3.9044013548112813E-014,&
                             -6.2348312267649191E-014, 4.2749491870564243E-014, 5.0781398149171470E-014 /)
    base_xcc(6, :)       = (/ 0.0000000000000000, 2.6014334064620091E-002, 4.7924579090095183E-002,&
                              2.5514382888176038E-002, 1.0559668525451661E-002, -3.5609593200274639E-002 /)

    call BD_TiSchmPredictorStep( x, OtherState, dt, coef, node_total )
    
    @assertEqual(base_q, x%q, tolerance, testname)
    @assertEqual(base_dqdt, x%dqdt, tolerance, testname)
    @assertEqual(base_acc, OtherState%acc, tolerance, testname)
    @assertEqual(base_xcc, OtherState%xcc, tolerance, testname)

    ! --------------------------------------------------------------------------
    testname = "more complex case--nonzero displacement (x%q /= 0):"

    call initialize_vars_base()

    dt   = 1.99999999999999999999999999999999989E-0003
    coef = (/ 0.00000000000000000000000000000000000, 0.00000000000000000000000000000000000,&
              0.00000000000000000000000000000000000, 4.99999999999999999999999999999999971E-0004,&
              0.00000000000000000000000000000000000, 0.500000000000000000000000000000000000,&
              1.49999999999999999999999999999999991E-0003, 1.99999999999999999999999999999999986E-0006,&
              0.500000000000000000000000000000000000 /)

    x%q(1, :)            = (/ 0.0000000000000000, 1.4905664621266180E-005, 5.4068579514625562E-005,&
                             -3.6940598017590663E-005, 9.4911397695851399E-006, 3.5051922687496496E-005 /)
    x%q(2, :)            = (/ -4.2012830852580361E-002, -0.34747496034168446, -0.97341578949967855,&
                              -1.7113436662365304, -2.3303831457442246, -2.6362879655384099 /)
    x%q(3, :)            = (/ -8.8292875972117990E-004, -6.8112753494857011E-003, -1.7856530407199755E-002,&
                              -2.8561600395910852E-002, -3.6342013324460423E-002, -4.1297733330897340E-002 /)
    x%q(4, :)            = (/ 4.2026746348243167E-002, 4.2298309885934249E-002, 4.2309898940478721E-002,&
                              4.1946988314270926E-002, 4.2099745887990057E-002, 4.2144118406259673E-002 /)
    x%q(5, :)            = (/ 0.0000000000000000, 5.3990694022568876E-006, -2.8541911535249440E-008,&
                             -1.1213850814947955E-005, 1.2001776783477460E-005, -3.0668213813850575E-005 /)
    x%q(6, :)            = (/ 0.0000000000000000, 3.6878368613362313E-006, 3.7579127083265454E-005,&
                              6.0235456312171705E-005, 1.4631858314098490E-005, 1.5042103751164396E-005 /)
    
    x%dqdt(1, :)         = (/ 0.0000000000000000, 8.2417447359274781E-004, 4.0281884385100523E-003,&
                             -1.9179751708176744E-003, -1.3901752869276429E-003, 1.1875431572126047E-002 /)
    x%dqdt(2, :)         = (/ -0.99971654148302291, -8.2497570342389785, -23.274797298393537,&
                             -40.972683268112696, -55.581086936752342, -63.085494132020962 /)
    x%dqdt(3, :)         = (/ -4.2038038551091908E-002, -0.36052884688904113, -1.0501846371013823,&
                              -1.9437144597723661, -2.7738699415014185, -3.1837609035671073 /)
    x%dqdt(4, :)         = (/ 1.0005999999999999, 1.0084219921366455, 1.0195549571913172,&
                              0.99854512138653251, 1.0026176766624864, 1.0279452971417928 /)
    x%dqdt(5, :)         = (/ 0.0000000000000000, 2.0181735176346246E-004, 2.1284838186727019E-004,&
                             -8.9630941828632569E-004, 1.0016804991817071E-003, 2.7054364177340469E-003 /)
    x%dqdt(6, :)         = (/ 0.0000000000000000, 6.5036865172917499E-005, 6.3235693518801973E-004,&
                              2.4861288791141259E-003, 1.5603168655238628E-003, -2.9542243827979683E-003 /)
    
    OtherState%acc(1, :) = (/ 0.0000000000000000, -5.0663104216986235E-002, 0.18978758053454178,&
                              9.5316985704030563E-003, -0.28541958108170223, 1.4258410696572072 /)
    OtherState%acc(2, :) = (/ 4.2063261374222560E-002, 3.5323537057845509, -1.1900442359732279,&
                            -10.832054269995265, -4.5533453965276607, -1.2179652979905604 /)
    OtherState%acc(3, :) = (/ -1.0003163714079126, -9.3338064908554124, -30.226569107369436,&
                             -64.211008946351981, -100.89729649584541, -117.52836651242384 /)
    OtherState%acc(4, :) = (/ 0.0000000000000000, -7.0559910565742762E-002, 0.67426213188581896,&
                              0.24657248302367937, -0.38515012627490441, -0.36151871850277062 /)
    OtherState%acc(5, :) = (/ 0.0000000000000000, -2.4320419912183112E-003, 2.8595257643862206E-002,&
                             -4.8942207162107267E-002, 6.2971949571734437E-002, 0.42691164958875322 /)
    OtherState%acc(6, :) = (/ 0.0000000000000000, 6.1849935768663426E-003, -3.8868928438697742E-002,&
                             -2.8973644621868733E-002, 0.17660094192237064, 9.3325781423304346E-002 /)
    
    OtherState%xcc(1, :) = (/ 0.0000000000000000, -2.7179909261050884E-002, 0.18169726495432081,&
                             -5.6985689532033316E-003, -0.24562232484855470, 1.2761598260401190 /)
    OtherState%xcc(2, :) = (/ 0.0000000000000000, 3.6109746509631102, -1.6523726015661013,&
                            -10.875449795254809, -3.9941000669255056, -4.5237884959578132 /)
    OtherState%xcc(3, :) = (/ -1.0012003599999999, -9.4550447496236902, -30.756187783880200,&
                             -66.444736342930042, -107.68856274111150, -127.94683049474561 /)
    OtherState%xcc(4, :) = (/ 0.0000000000000000, -6.6280729598654858E-002, 0.70196118359965154,&
                              0.18022327400505284, -0.27815137436157178, 3.8426862206468376E-002 /)
    OtherState%xcc(5, :) = (/ 0.0000000000000000, -1.4400893616312957E-003, 2.5308211242178278E-002,&
                             -4.6541486131784542E-002, 5.9377926408415500E-002, 0.39195860760356505 /)
    OtherState%xcc(6, :) = (/ 0.0000000000000000, 7.5223679358316668E-003, -3.8850624572698111E-002,&
                             -1.2287165704709804E-002, 0.15343537017145661, -6.3672377581623779E-002 /)
    
    base_q(1, :)         = (/ 0.0000000000000000, 1.6554013568451675E-005, 6.2124956391645665E-005,&
                             -4.0776548359226012E-005, 6.7107891957298545E-006, 5.8802785831748588E-005 /)
    base_q(2, :)         = (/ -4.2012830852580361E-002, -0.36397447441016240, -1.0199653840964655,&
                              -1.7932890327727558, -2.4415453196177292, -2.7624589538024518 /)
    base_q(3, :)         = (/ -8.8292875972117990E-004, -7.5323330432637836E-003, -1.9956899681402521E-002,&
                              -3.2449029315455583E-002, -4.1889753207463257E-002, -4.7665255138031555E-002 /)
    base_q(4, :)         = (/ 4.2026746348243167E-002, 4.4315390152215056E-002, 4.4349248001126988E-002,&
                              4.3944308613344182E-002, 4.4105213947404291E-002, 4.4200248303467332E-002 /)
    base_q(5, :)         = (/ 0.0000000000000000, 5.8017515193588100E-006, 3.8555236198734030E-007,&
                             -1.2962267654549190E-005, 1.4056079954817177E-005, -2.5398174241241125E-005 /)
    base_q(6, :)         = (/ 0.0000000000000000, 3.8148437965007688E-006, 3.8835073803042559E-005,&
                              6.5234235290735211E-005, 1.7722192393894670E-005, 8.9888607709793126E-006 /)
    
    base_dqdt(1, :)      = (/ 0.0000000000000000, 8.1058451896222241E-004, 4.1190370709872125E-003,&
                             -1.9208244552942760E-003, -1.5129864493519203E-003, 1.2513511485146107E-002 /)
    base_dqdt(2, :)      = (/ -0.99971654148302291, -8.2479515469134963, -23.275623484694322,&
                             -40.978120993010322, -55.583083986785802, -63.087756026268941 /)
    base_dqdt(3, :)      = (/ -4.2038038551091908E-002, -0.36525636926385296, -1.0655627309933224,&
                              -1.9769368279438311, -2.8277142228719745, -3.2477343188144800 /)
    base_dqdt(4, :)      = (/ 1.0005999999999999, 1.0083888517718462, 1.0199059377831170,&
                              0.99863523302353507, 1.0024786009753055, 1.0279645105728961 /)
    base_dqdt(5, :)      = (/ 0.0000000000000000, 2.0109730708264682E-004, 2.2550248748835934E-004,&
                             -9.1958016135221796E-004, 1.0313694623859148E-003, 2.9014157215358294E-003 /)
    base_dqdt(6, :)      = (/ 0.0000000000000000, 6.8798049140833331E-005, 6.1293162290167072E-004,&
                              2.4799852962617708E-003, 1.6370345506095912E-003, -2.9860605715887802E-003 /)
    
    base_acc(2, 1)       = 4.2063261374222560E-002
    base_acc(3, 1)       = -1.0003163714079126
    
    base_xcc(1, :)       = (/ 0.0000000000000000, -1.3589954630525442E-002, 9.0848632477160407E-002,&
                             -2.8492844766016658E-003, -0.12281116242427735, 0.63807991302005951 /)
    base_xcc(2, :)       = (/ 0.0000000000000000, 1.8054873254815551, -0.82618630078305066,&
                             -5.4377248976274046, -1.9970500334627528, -2.2618942479789066 /)
    base_xcc(3, :)       = (/ -1.0012003599999999, -4.7275223748118451, -15.378093891940100,&
                             -33.222368171465021, -53.844281370555748, -63.973415247372806 /)
    base_xcc(4, :)       = (/ 0.0000000000000000, -3.3140364799327429E-002, 0.35098059179982577,&
                              9.0111637002526418E-002, -0.13907568718078589, 1.9213431103234188E-002 /)
    base_xcc(5, :)       = (/ 0.0000000000000000, -7.2004468081564787E-004, 1.2654105621089139E-002,&
                             -2.3270743065892271E-002, 2.9688963204207750E-002, 0.19597930380178252 /)
    base_xcc(6, :)       = (/ 0.0000000000000000, 3.7611839679158334E-003, -1.9425312286349056E-002,&
                             -6.1435828523549018E-003, 7.6717685085728307E-002, -3.1836188790811890E-002 /)

    call BD_TiSchmPredictorStep( x, OtherState, dt, coef, node_total )
    
    @assertEqual(base_q, x%q, tolerance, testname)
    @assertEqual(base_dqdt, x%dqdt, tolerance, testname)
    @assertEqual(base_acc, OtherState%acc, tolerance, testname)
    @assertEqual(base_xcc, OtherState%xcc, tolerance, testname)

    ! --------------------------------------------------------------------------
    
    contains
       subroutine initialize_vars_base()
          coef           = 0.0d0
          x%q            = 0.0d0
          x%dqdt         = 0.0d0
          OtherState%acc = 0.0d0
          OtherState%xcc = 0.0d0
          
          base_q         = 0.0d0
          base_dqdt      = 0.0d0
          base_acc       = 0.0d0
          base_xcc       = 0.0d0
       end subroutine initialize_vars_base

end subroutine test_BD_TiSchmPredictorStep
